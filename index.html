<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü•û –ú–∞—Å–ª–µ–Ω–∏—Ü–∞</title>

<style>
body{
    margin:0;
    font-family:Arial,sans-serif;
    text-align:center;
    overflow:hidden;
    background:
    radial-gradient(circle at 20% 20%, #ffcc66 8%, transparent 9%),
    radial-gradient(circle at 80% 30%, #ff6666 8%, transparent 9%),
    linear-gradient(135deg,#ffefba,#ffffff);
}

#stats{
    font-size:22px;
    font-weight:bold;
    margin-top:10px;
}

#game{
    position:relative;
    width:95vw;
    max-width:500px;
    height:60vh;
    margin:10px auto;
    border:4px solid #b22222;
    border-radius:15px;
    background:linear-gradient(#e0f7ff,#ffffff);
    overflow:hidden;
}

.item{
    position:absolute;
    font-size:8vw;
}

#player{
    position:absolute;
    bottom:10px;
    font-size:14vw;
    transition:left 0.1s;
}

#overlay{
    position:absolute;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.9);
    color:white;
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    padding:20px;
    box-sizing:border-box;
    text-align:center;
    z-index:10;
}

#controls{
    margin-top:10px;
}

.controlBtn{
    font-size:28px;
    padding:10px 25px;
    margin:5px;
    border:none;
    border-radius:12px;
    background:#ffcc66;
}
</style>
</head>
<body>

<h2>ü•û –ú–∞—Å–ª–µ–Ω–∏—Ü–∞</h2>

<div id="stats">
‚è≥ <span id="time">90</span> |
ü•û <span id="caught">0</span>
</div>

<div id="game">
    <div id="player">ü™Ü</div>
    <div id="overlay"></div>
</div>

<div id="controls">
    <button class="controlBtn" onclick="moveLeft()">‚¨ÖÔ∏è</button>
    <button class="controlBtn" onclick="moveRight()">‚û°Ô∏è</button>
</div>

<script>
const game=document.getElementById("game");
const player=document.getElementById("player");
const overlay=document.getElementById("overlay");
const timeDisplay=document.getElementById("time");
const caughtDisplay=document.getElementById("caught");
const controls=document.getElementById("controls");

let columns;
let playerColumn=1;

let caught=0;
let wrong=0;
let missed=0;

let timeLeft=90;
let gameActive=false;

let speed=3;
let activeColumns=[false,false,false];

if(localStorage.getItem("maslenitsaPlayed")){
    overlay.innerHTML="<h2>üéâ –ò–≥—Ä–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>";
    controls.style.display="none";
}else{
    showTutorial();
}

function showTutorial(){
    overlay.innerHTML=`
        <h2>üìú –û–±—É—á–µ–Ω–∏–µ</h2>
        <p>–õ–æ–≤–∏ ü•û ‚Äî –ø–æ–ª—É—á–∞–µ—à—å –æ—á–∫–∏</p>
        <p>–ù–µ –ª–æ–≤–∏ üí© ‚Äî —ç—Ç–æ –æ—à–∏–±–∫–∞</p>
        <p>üí£ –æ—Ç–Ω–∏–º–∞–µ—Ç 1 –±–ª–∏–Ω</p>
        <p>–ò–≥—Ä–∞ –¥–ª–∏—Ç—Å—è 90 —Å–µ–∫—É–Ω–¥</p>
        <p>–ò–õ–ò –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ 50 –±–ª–∏–Ω–∞—Ö</p>
        <br>
        <button onclick="startGame()" style="padding:10px 20px;font-size:18px;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    `;
}

function startGame(){
    overlay.style.display="none";
    gameActive=true;
}

function updateColumns(){
    const w=game.clientWidth;
    columns=[w*0.15,w*0.45,w*0.75];
    player.style.left=columns[playerColumn]+"px";
}
window.addEventListener("resize",updateColumns);
updateColumns();

function moveLeft(){
    if(!gameActive) return;
    if(playerColumn>0){
        playerColumn--;
        player.style.left=columns[playerColumn]+"px";
    }
}

function moveRight(){
    if(!gameActive) return;
    if(playerColumn<2){
        playerColumn++;
        player.style.left=columns[playerColumn]+"px";
    }
}

document.addEventListener("keydown",(e)=>{
    if(e.key==="ArrowLeft") moveLeft();
    if(e.key==="ArrowRight") moveRight();
});

function getFreeColumn(){
    let free=[];
    for(let i=0;i<3;i++){
        if(!activeColumns[i]) free.push(i);
    }
    if(free.length===0) return null;
    return free[Math.floor(Math.random()*free.length)];
}

function createItem(){
    if(!gameActive) return;

    let col=getFreeColumn();
    if(col===null) return;
    activeColumns[col]=true;

    const item=document.createElement("div");
    item.classList.add("item");

    let rand=Math.random();
    let type;

    if(rand<0.45) type="pancake";
    else if(rand<0.85) type="poop";
    else type="bomb";

    item.textContent= type==="pancake"?"ü•û":type==="poop"?"üí©":"üí£";
    item.style.left=columns[col]+"px";
    game.appendChild(item);

    let pos=0;

    function fall(){
        if(!gameActive) return;

        pos+=speed;
        item.style.top=pos+"px";

        if(pos>game.clientHeight-100){

            if(col===playerColumn){

                if(type==="pancake"){
                    caught++;
                    if(caught>=50){
                        caught=50;
                        caughtDisplay.textContent=caught;
                        activeColumns[col]=false;
                        item.remove();
                        endGame();
                        return;
                    }
                }

                if(type==="poop") wrong++;

                if(type==="bomb"){
                    caught--;
                    if(caught<0) caught=0;
                }

            }else{
                if(type==="pancake") missed++;
            }

            caughtDisplay.textContent=caught;
            activeColumns[col]=false;
            item.remove();
            return;
        }

        requestAnimationFrame(fall);
    }

    requestAnimationFrame(fall);
}

let spawn=setInterval(()=>{
    if(!gameActive) return;
    createItem();
},800);

setInterval(()=>{
    if(gameActive){
        speed *= 1.05;
    }
},5000);

const timer=setInterval(()=>{
    if(!gameActive) return;

    timeLeft--;
    timeDisplay.textContent=timeLeft;

    if(timeLeft<=0){
        endGame();
    }
},1000);

function calculateResults(){

    let catchBonus=0;
    let errorBonus=0;
    let missBonus=0;

    if(caught<=3) catchBonus=0;
    else if(caught<=6) catchBonus=1;
    else if(caught<=10) catchBonus=2;
    else if(caught<=20) catchBonus=3;
    else if(caught<=30) catchBonus=4;
    else if(caught<=35) catchBonus=5;
    else if(caught<=40) catchBonus=6;
    else if(caught<=49) catchBonus=5;
    else if(caught==50) catchBonus=10;

    if(wrong>=20) errorBonus=0;
    else if(wrong>=15) errorBonus=1;
    else if(wrong>=10) errorBonus=2;
    else if(wrong>=5) errorBonus=3;
    else if(wrong>=3) errorBonus=4;
    else if(wrong>=1) errorBonus=5;
    else if(wrong==0) errorBonus=10;

    if(missed<=3) missBonus=10;
    else if(missed<=5) missBonus=9;
    else if(missed<=8) missBonus=8;
    else if(missed<=15) missBonus=7;
    else if(missed<=20) missBonus=6;
    else if(missed<=30) missBonus=5;
    else if(missed<=36) missBonus=4;
    else if(missed<=41) missBonus=3;
    else missBonus=0;

    let total=catchBonus+errorBonus+missBonus;

    return {catchBonus,errorBonus,missBonus,total};
}

function endGame(){
    gameActive=false;
    clearInterval(spawn);
    clearInterval(timer);
    localStorage.setItem("maslenitsaPlayed","true");
    controls.style.display="none";

    let r=calculateResults();

    overlay.style.display="flex";
    overlay.innerHTML=`
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã:</h2>
        <p>–ü–æ–π–º–∞–Ω–æ –±–ª–∏–Ω–æ–≤: ${caught}(+${r.catchBonus})</p>
        <p>–ü–æ–π–º–∞–Ω–æ –æ—à–∏–±–æ–∫: ${wrong}(+${r.errorBonus})</p>
        <p>–ü—Ä–æ–ø—É—â–µ–Ω–æ –±–ª–∏–Ω–æ–≤: ${missed}(+${r.missBonus})</p>
        <h3>–ò–¢–û–ì–û: ${r.total} –±–ª–∏–Ω–æ–≤</h3>
        <p>–û—Ç–ø—Ä–∞–≤—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –≥—Ä—É–ø–ø—É, —á—Ç–æ–±—ã –∑–∞—Å—á–∏—Ç–∞—Ç—å!</p>
    `;
}
</script>

</body>
</html>
